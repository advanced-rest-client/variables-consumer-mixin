<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
  <title>variables-consumer-mixin test</title>

  <script src="../../../@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../../../@polymer/test-fixture/test-fixture.js"></script>
  <script src="../../../mocha/mocha.js"></script>
  <script src="../../../chai/chai.js"></script>
  <script src="../../../wct-mocha/wct-mocha.js"></script>

</head>
<body>
  <test-fixture id="Basic">
    <template>
      <vars-consumer></vars-consumer>
    </template>
  </test-fixture>

  <script type="module">
  import './vars-consumer.js';
  import {afterNextRender} from '../../../@polymer/polymer/lib/utils/render-status.js';
  import sinon from '../../../sinon/pkg/sinon-esm.js';
  suite('variables-consumer-mixin', () => {
    function noopEvent(e) {
      e.preventDefault();
      e.detail.result = Promise.resolve();
    }

    function noopEnvironmentList() {
      window.addEventListener('environment-list', function f(e) {
        window.removeEventListener('environment-list', f);
        noopEvent(e);
      });
    }

    function rejectEnvironmentList() {
      window.addEventListener('environment-list', function f(e) {
        window.removeEventListener('environment-list', f);
        e.preventDefault();
        e.detail.result = Promise.reject(new Error('test'));
      });
    }

    function noopEnvironmentCurrent() {
      window.addEventListener('environment-current', function f(e) {
        window.removeEventListener('environment-current', f);
        e.preventDefault();
        e.detail.result = Promise.resolve({
          environment: '',
          variables: []
        });
      });
    }

    suite('Initialization flow', () => {
      test('Asks for current environment', () => {
        noopEnvironmentList();
        let called = false;
        window.addEventListener('environment-current', function f() {
          window.removeEventListener('environment-current', f);
          called = true;
        });
        fixture('Basic');
        assert.isTrue(called);
      });

      test('Sets environment from the event', () => {
        noopEnvironmentList();
        window.addEventListener('environment-current', function f(e) {
          window.removeEventListener('environment-current', f);
          e.preventDefault();
          e.detail.environment = 'test';
        });
        const element = fixture('Basic');
        assert.equal(element.environment, 'test');
      });

      test('Sets variables from the event', () => {
        noopEnvironmentList();
        window.addEventListener('environment-current', function f(e) {
          window.removeEventListener('environment-current', f);
          e.preventDefault();
          e.detail.variables = ['test'];
        });
        const element = fixture('Basic');
        assert.deepEqual(element.variables, ['test']);
      });

      test('Asks for environments list', () => {
        let called = false;
        window.addEventListener('environment-list', function f(e) {
          window.removeEventListener('environment-list', f);
          noopEvent(e);
          called = true;
        });
        fixture('Basic');
        assert.isTrue(called);
      });

      test('Sets environments list from the event', (done) => {
        window.addEventListener('environment-list', function f(e) {
          window.removeEventListener('environment-list', f);
          e.preventDefault();
          e.detail.result = Promise.resolve(['test']);
        });
        const element = fixture('Basic');
        setTimeout(() => {
          assert.deepEqual(element.environments, ['test']);
          done();
        });
      });

      test('refreshEnvironments() rejects when no model', (done) => {
        noopEnvironmentList();
        const element = fixture('Basic');
        element.refreshEnvironments()
        .catch(() => {
          done();
        });
      });

      // test('refreshEnvironments() repets event when no model', (done) => {
      //   const element = fixture('Basic');
      //   element._retryingModel = false;
      //   element.refreshEnvironments()
      //   .then(() => {
      //     done();
      //   });
      //   noopEnvironmentList();
      // });
    });

    suite('_dispatch()', () => {
      let element;
      setup(() => {
        element = fixture('Basic');
      });

      const eName = 'test-event';
      const eDetail = 'test-detail';

      test('Dispatches an event', () => {
        const spy = sinon.spy();
        element.addEventListener(eName, spy);
        element._dispatch(eName);
        assert.isTrue(spy.called);
      });

      test('Returns the event', () => {
        const e = element._dispatch(eName);
        assert.typeOf(e, 'customevent');
      });

      test('Event is cancelable by default', () => {
        const e = element._dispatch(eName);
        assert.isTrue(e.cancelable);
      });

      test('Event is composed', () => {
        const e = element._dispatch(eName);
        if (typeof e.composed !== 'undefined') {
          assert.isTrue(e.composed);
        }
      });

      test('Event bubbles', () => {
        const e = element._dispatch(eName);
        assert.isTrue(e.bubbles);
      });

      test('Event is not cancelable when set', () => {
        const e = element._dispatch(eName, eDetail, false);
        assert.isFalse(e.cancelable);
      });

      test('Event has detail', () => {
        const e = element._dispatch(eName, eDetail);
        assert.equal(e.detail, eDetail);
      });
    });

    suite('_initializeVariables()', () => {
      let element;
      setup(() => {
        element = fixture('Basic');
      });

      test('Does nothing when environment is set', () => {
        const spy = sinon.spy(element, 'refreshState');
        element.environment = 'test';
        element._initializeVariables();
        assert.isFalse(spy.called);
      });

      test('Calls refreshState()', () => {
        noopEnvironmentList();
        noopEnvironmentCurrent();
        const spy = sinon.spy(element, 'refreshState');
        element._initializeVariables();
        assert.isTrue(spy.called);
      });

      test('Calls refreshEnvironments()', () => {
        noopEnvironmentList();
        noopEnvironmentCurrent();
        const spy = sinon.spy(element, 'refreshEnvironments');
        element._initializeVariables();
        assert.isTrue(spy.called);
      });

      test('Handles promise rejection', () => {
        rejectEnvironmentList();
        return element._dataImportHandler();
      });
    });

    suite('_dataImportHandler()', () => {
      let element;
      setup(() => {
        element = fixture('Basic');
      });

      test('Calls refreshEnvironments()', () => {
        noopEnvironmentList();
        const spy = sinon.spy(element, 'refreshEnvironments');
        element._dataImportHandler();
        assert.isTrue(spy.called);
      });

      test('Handles promise rejection', () => {
        rejectEnvironmentList();
        return element._dataImportHandler();
      });
    });

    suite('_onDatabaseDestroy()', () => {
      let element;
      setup(() => {
        noopEnvironmentList();
        noopEnvironmentCurrent();

        element = fixture('Basic');
      });

      test('Does noting when no datastore property', () => {
        noopEnvironmentList();
        noopEnvironmentCurrent();
        const result = element._onDatabaseDestroy({detail: {}});
        assert.isFalse(result);
      });

      test('Does noting when empty datastore property', () => {
        const result = element._onDatabaseDestroy({detail: {
          datastore: []
        }});
        assert.isFalse(result);
      });

      test('Does noting when other datastore', () => {
        const result = element._onDatabaseDestroy({detail: {
          datastore: ['other']
        }});
        assert.isFalse(result);
      });

      test('Schedules refresh when "variables" datastore', () => {
        const result = element._onDatabaseDestroy({detail: {
          datastore: ['variables']
        }});
        assert.isTrue(result);
      });

      test('Schedules refresh when datastore is string', () => {
        const result = element._onDatabaseDestroy({detail: {
          datastore: 'variables'
        }});
        assert.isTrue(result);
      });

      test('Schedules refresh when "variables-environments" store', () => {
        const result = element._onDatabaseDestroy({detail: {
          datastore: 'variables-environments'
        }});
        assert.isTrue(result);
      });

      test('Schedules refresh when "all" store', () => {
        const result = element._onDatabaseDestroy({detail: {
          datastore: 'all'
        }});
        assert.isTrue(result);
      });

      test('Eventually resets "environment"', (done) => {
        element._onDatabaseDestroy({detail: {
          datastore: 'all'
        }});
        afterNextRender(element, () => {
          assert.isUndefined(element.environment);
          done();
        });
      });

      test('Eventually calls refreshState()', (done) => {
        element._onDatabaseDestroy({detail: {
          datastore: 'all'
        }});
        noopEnvironmentList();
        noopEnvironmentCurrent();
        const spy = sinon.spy(element, 'refreshState');
        afterNextRender(element, () => {
          assert.isTrue(spy.called);
          done();
        });
      });

      test('Eventually calls _initVariables()', (done) => {
        element._onDatabaseDestroy({detail: {
          datastore: 'all'
        }});
        noopEnvironmentList();
        noopEnvironmentCurrent();
        const spy = sinon.spy(element, '_initVariables');
        afterNextRender(element, () => {
          assert.isTrue(spy.called);
          done();
        });
      });
    });

    function fire(type, detail, cancelable) {
      if (!detail) {
        detail = {};
      }
      const e = new CustomEvent(type, {
        bubbles: true,
        cancelable,
        detail
      });
      document.body.dispatchEvent(e);
    }

    suite('selected-environment-changed', function() {
      let element;
      setup(() => {
        noopEnvironmentList();
        element = fixture('Basic');
      });

      test('Updates environment from the event', function() {
        fire('selected-environment-changed', {
          value: 'test'
        });
        assert.equal(element.environment, 'test');
      });

      test('Does nothing when the same environment', function() {
        element.environment = 'test';
        element.variables = [];
        fire('selected-environment-changed', {
          value: 'test'
        });
        assert.typeOf(element.variables, 'array');
      });

      test('Clears variables', function() {
        element.variables = ['test'];
        fire('selected-environment-changed', {
          value: 'test'
        });
        assert.isUndefined(element.variables);
      });
    });

    suite('variables-list-changed', function() {
      let element;
      let items;
      setup(() => {
        noopEnvironmentList();
        element = fixture('Basic');
        items = [{_id: 1}, {_id: 2}];
      });

      test('Updates variables from the event', function() {
        fire('variables-list-changed', {
          value: items
        });
        assert.deepEqual(element.variables, items);
      });

      test('Variables list is a copy', function() {
        fire('variables-list-changed', {
          value: items
        });
        items[0]._id = 3;
        assert.equal(element.variables[0]._id, 1);
      });

      test('Does nothing if event is cancelable', function() {
        fire('variables-list-changed', {
          value: items
        }, true);
        assert.isUndefined(element.variables);
      });
    });

    suite('variable-updated', function() {
      let element;
      let items;
      setup(() => {
        noopEnvironmentList();
        element = fixture('Basic');
        items = [{
          _id: 'a',
          environment: 'test',
          value: 'a'
        }, {
          _id: 'b',
          environment: 'test',
          value: 'b'
        }];
      });

      test('Ignores the event when different environment', () => {
        element.environment = 'default';
        fire('variable-updated', {
          value: items[0]
        });
        assert.isUndefined(element.variables);
      });

      test('Adds variable to undefined list', () => {
        element.environment = 'test';
        fire('variable-updated', {
          value: items[0]
        });
        assert.deepEqual(element.variables, [items[0]]);
      });

      test('Appends variable to the list', () => {
        element.environment = 'test';
        element.variables = [items[0]];
        fire('variable-updated', {
          value: items[1]
        });
        assert.deepEqual(element.variables, items);
      });

      test('Updates a variable', () => {
        element.environment = 'test';
        element.variables = items;
        const item = Object.assign({}, items[0]);
        item.value = 'c';
        fire('variable-updated', {
          value: item
        });
        assert.deepEqual(element.variables[0], item);
      });

      test('Does nothing if event is cancelable', function() {
        const item = Object.assign({}, items[0]);
        fire('variable-updated', {
          value: item
        }, true);
        assert.isUndefined(element.variables);
      });
    });

    suite('variable-deleted', function() {
      let element;
      let items;
      setup(() => {
        noopEnvironmentList();
        element = fixture('Basic');
        items = [{_id: 'a'}, {_id: 'b'}, {_id: 'c'}];
        element.variables = items;
      });

      test('Does nothing when no items on the list', function() {
        fire('variable-deleted', {
          id: 'x'
        });
        // no error
      });

      test('Removes item from the list', function() {
        fire('variable-deleted', {
          id: 'b'
        });
        assert.lengthOf(element.variables, 2);
        assert.equal(element.variables[0]._id, 'a');
        assert.equal(element.variables[1]._id, 'c');
      });

      test('Does nothing when event is cancelable', function() {
        fire('variable-deleted', {
          id: 'b'
        }, true);
        assert.lengthOf(element.variables, 3);
      });
    });

    suite('environment-deleted', function() {
      let element;
      let items;
      setup(() => {
        noopEnvironmentList();
        element = fixture('Basic');
        items = [{_id: 'a'}, {_id: 'b'}, {_id: 'c'}];
        element.environments = items;
      });

      test('Does nothing when no items on the list', function() {
        fire('environment-deleted', {
          id: 'x'
        });
        // no error
      });

      test('Removes item from the list', function() {
        fire('environment-deleted', {
          id: 'b'
        });
        assert.lengthOf(element.environments, 2);
        assert.equal(element.environments[0]._id, 'a');
        assert.equal(element.environments[1]._id, 'c');
      });

      test('Does nothing when event is cancelable', function() {
        fire('environment-deleted', {
          id: 'b'
        }, true);
        assert.lengthOf(element.environments, 3);
      });

      test('Does nothing when environments are not set', function() {
        element.environments = undefined;
        fire('environment-deleted', {
          id: 'b'
        });
      });
    });

    suite('environment-updated', function() {
      let element;
      let items;
      setup(() => {
        noopEnvironmentList();
        element = fixture('Basic');
        items = [{
          _id: 'a',
          name: 'a'
        }, {
          _id: 'b',
          name: 'b'
        }];
      });

      test('Adds environment to undefined list', () => {
        fire('environment-updated', {
          value: items[0]
        });
        assert.deepEqual(element.environments, [items[0]]);
      });

      test('Appends environment to the list', () => {
        element.environments = [items[0]];
        fire('environment-updated', {
          value: items[1]
        });
        assert.deepEqual(element.environments, items);
      });

      test('Updates an environment', () => {
        element.environments = items;
        const item = Object.assign({}, items[0]);
        item.name = 'c';
        fire('environment-updated', {
          value: item
        });
        assert.deepEqual(element.environments[0], item);
      });

      test('Does nothing when event is cancelable', () => {
        element.environments = items;
        const item = Object.assign({}, items[0]);
        item.name = 'c';
        fire('environment-updated', {
          value: item
        }, true);
        assert.deepEqual(element.environments, items);
      });
    });

    suite('Auto computations', function() {
      let element;
      setup(() => {
        noopEnvironmentList();
        element = fixture('Basic');
      });

      test('hasVariables is false by default', function() {
        assert.isFalse(element.hasVariables);
      });

      test('hasVariables is computed', function() {
        element.variables = [{
          _id: 'b',
          bariable: 'b'
        }];
        assert.isTrue(element.hasVariables);
      });

      test('hasEnvironments is false by default', function() {
        assert.isFalse(element.hasEnvironments);
      });

      test('hasEnvironments is computed', function() {
        element.environments = [{
          _id: 'b',
          name: 'b'
        }];
        assert.isTrue(element.hasEnvironments);
      });
    });
  });
  </script>
</body>
</html>
